# Planning 模块速度调试日志添加总结

## ✅ 已完成的修改

### 1. 修改的文件列表

| 文件 | 模块 | 添加位置 | 日志类型 |
|------|------|---------|---------|
| `behavior_path_planner_node.cpp` | BPP 主节点 | 路径发布前 | INFO_THROTTLE (1秒) |
| `goal_planner_module.cpp` | Goal Planner | `decideVelocity()` 函数 | INFO + DEBUG |
| `static_obstacle_avoidance_module.cpp` | 避障模块 | `insertAvoidanceVelocity()` 函数 | INFO_THROTTLE + DEBUG |
| `autoware_obstacle_cruise_planner/src/node.cpp` | 障碍物巡航 | 轨迹发布前 | INFO_THROTTLE (1秒) |

---

## 📝 添加的日志内容

### 1. BPP 主节点输出日志

**文件**: `behavior_path_planner_node.cpp` (第401-411行)

**功能**: 记录 BPP 最终输出路径的速度信息

**日志格式**:
```
[VEL_DEBUG][BPP][PUBLISH] Output path: points=<数量>, first_vel=<首点速度> m/s, last_vel=<末点速度> m/s
```

**示例输出**:
```
[INFO] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path: points=150, first_vel=1.234 m/s, last_vel=0.000 m/s
```

**调试价值**: 
- ✅ 确认 BPP 输出的路径速度
- ✅ 检查首末点速度是否合理
- ✅ 作为速度传递链的起点

---

### 2. Goal Planner 速度决策日志

**文件**: `goal_planner_module.cpp` (第1436-1462行)

**功能**: 记录目标点规划时的速度决策过程

**日志格式**:
```
[VEL_DEBUG][GoalPlanner][DECIDE] current_vel=<当前速度>, min_vel=<最小速度>, decided_vel=<决定速度>, path_points=<点数>
[VEL_DEBUG][GoalPlanner][MODIFY] Modified <修改数>/<总数> points velocity
```

**示例输出**:
```
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][DECIDE] current_vel=1.200, min_vel=0.300, decided_vel=1.200, path_points=80
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][MODIFY] Modified 45/80 points velocity
```

**调试价值**:
- ✅ 理解速度决策逻辑（max(当前速度, 最小速度)）
- ✅ 发现为何保持当前速度或使用最小速度
- ✅ 统计有多少路径点被修改

---

### 3. 静态避障速度插入日志

**文件**: `static_obstacle_avoidance_module.cpp` (第1971-2054行)

**功能**: 记录避障时的速度调整过程

**日志格式**:
```
[VEL_DEBUG][Avoidance][SKIP] <跳过原因>
[VEL_DEBUG][Avoidance][INSERT] v_max=<最大速度>, accel_end_dist=<加速距离>, target_objs=<目标数>, ego_speed=<当前速度>
[VEL_DEBUG][Avoidance][POINT_<索引>] <原速度> -> <新速度> m/s (ego=<当前>, target=<目标>, dist=<距离>)
[VEL_DEBUG][Avoidance][RESULT] Modified <修改数> points velocity
```

**示例输出**:
```
[INFO] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][INSERT] v_max=1.500 m/s, accel_end_dist=10.500 m, target_objs=2, ego_speed=1.200 m/s
[DEBUG] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][POINT_0] 1.500 -> 1.234 m/s (ego=1.200, target=1.234, dist=0.00)
[INFO] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][RESULT] Modified 35 points velocity
```

**调试价值**:
- ✅ 了解避障是否触发
- ✅ 查看避障速度计算参数
- ✅ 跟踪速度修改过程
- ✅ 诊断避障导致的速度变化

---

### 4. Obstacle Cruise Planner 输出日志

**文件**: `autoware_obstacle_cruise_planner/src/node.cpp` (第723-755行)

**功能**: 记录障碍物巡航规划的输入输出速度

**日志格式**:
```
[VEL_DEBUG][ObstacleCruise][PUBLISH] Input_vel=<输入速度> -> Output_vel=<输出速度> (first), last_vel=<末点速度>, points=<点数>
[VEL_DEBUG][ObstacleCruise][LIMIT] Cruise limit: <巡航限速>, obstacles: <障碍物数>
[VEL_DEBUG][ObstacleCruise][LIMIT] Slow down limit: <减速限速>, obstacles: <障碍物数>
```

**示例输出**:
```
[INFO] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][PUBLISH] Input_vel=1.234 -> Output_vel=0.800 (first), last_vel=0.000, points=120
[INFO] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][LIMIT] Cruise limit: 0.800 m/s, obstacles: 1
```

**调试价值**:
- ✅ 对比输入输出速度变化
- ✅ 了解巡航和减速限制
- ✅ 检测障碍物对速度的影响

---

## 🛠️ 使用方法

### 1. 重新编译修改的模块

```bash
cd /home/huanyue/weicanming/github_programs/autoware/Autoware_Debug

# 编译修改的包
colcon build --packages-select \
  autoware_behavior_path_planner \
  autoware_behavior_path_goal_planner_module \
  autoware_behavior_path_static_obstacle_avoidance_module \
  autoware_obstacle_cruise_planner \
  --cmake-args -DCMAKE_BUILD_TYPE=RelWithDebInfo

# 重新 source
source install/setup.bash
```

### 2. 启动 Autoware

```bash
# 使用您的正常启动命令
ros2 launch autoware_launch ...
```

### 3. 监控速度调试日志

#### 方法A: 使用提供的监控脚本（推荐）

```bash
# 交互式监控所有速度日志
./monitor_velocity_debug.sh

# 选项:
# 1 - 所有速度调试日志
# 2 - 仅 BPP 输出
# 3 - 仅 Goal Planner
# 4 - 仅 Avoidance
# 5 - 仅 Obstacle Cruise
# 6 - 仅显示速度修改
```

#### 方法B: 使用速度链对比脚本

```bash
# 实时对比各模块速度传递
./compare_velocity_chain.sh
```

显示效果：
```
==========================================
  速度传递链实时监控
==========================================

时间: 14:30:25

速度传递流程:

  当前车速:              1.200 m/s
         ↓
  BPP 输出:              1.234 m/s
         ↓
  Obstacle Cruise:       0.800 m/s
         ↓
  控制命令:              0.800 m/s

==========================================
BPP → Cruise 差异:  -0.434 m/s
Cruise → Control 差异: 0.000 m/s
当前 → 目标 差异:   -0.400 m/s
```

#### 方法C: 手动过滤日志

```bash
# 查看所有速度调试日志
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]"

# 仅查看 BPP 输出
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]\[BPP\]"

# 仅查看速度修改
ros2 topic echo /rosout | grep "\[VEL_DEBUG\].*MODIFY"

# 保存到文件
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]" > velocity_debug.log
```

### 4. 调整日志级别

如果想看到 DEBUG 级别的详细日志：

```bash
# 使用 rqt_logger_level GUI
ros2 run rqt_logger_level rqt_logger_level

# 或命令行设置
ros2 service call /behavior_path_planner/set_log_level \
  rcl_interfaces/srv/SetLoggerLevel \
  "{logger_name: '', level: 10}"  # 10 = DEBUG

ros2 service call /goal_planner/set_log_level \
  rcl_interfaces/srv/SetLoggerLevel \
  "{logger_name: '', level: 10}"

ros2 service call /static_obstacle_avoidance/set_log_level \
  rcl_interfaces/srv/SetLoggerLevel \
  "{logger_name: '', level: 10}"

ros2 service call /obstacle_cruise_planner/set_log_level \
  rcl_interfaces/srv/SetLoggerLevel \
  "{logger_name: '', level: 10}"
```

---

## 📊 日志分析示例

### 场景1: 速度正常传递

```
[INFO] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path: points=150, first_vel=1.500 m/s, last_vel=0.000 m/s
[INFO] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][PUBLISH] Input_vel=1.500 -> Output_vel=1.500 (first), last_vel=0.000, points=150
```

**分析**: 速度正常传递，无障碍物影响

---

### 场景2: 障碍物巡航减速

```
[INFO] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path: points=150, first_vel=1.500 m/s, last_vel=0.000 m/s
[INFO] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][LIMIT] Cruise limit: 0.800 m/s, obstacles: 1
[INFO] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][PUBLISH] Input_vel=1.500 -> Output_vel=0.800 (first), last_vel=0.000, points=150
```

**分析**: 检测到障碍物，巡航速度从 1.5 降到 0.8 m/s

---

### 场景3: Goal Planner 限制速度

```
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][DECIDE] current_vel=1.200, min_vel=0.300, decided_vel=1.200, path_points=80
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][MODIFY] Modified 45/80 points velocity
[INFO] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path: points=80, first_vel=1.200 m/s, last_vel=0.000 m/s
```

**分析**: Goal Planner 使用当前速度 (1.2 m/s) 作为上限，修改了 45 个路径点

---

### 场景4: 避障触发减速

```
[INFO] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][INSERT] v_max=1.500 m/s, accel_end_dist=10.500 m, target_objs=2, ego_speed=1.200 m/s
[DEBUG] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][POINT_0] 1.500 -> 1.234 m/s (ego=1.200, target=1.234, dist=0.00)
[INFO] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][RESULT] Modified 35 points velocity
```

**分析**: 避障模块检测到 2 个目标，修改了 35 个点的速度

---

### 场景5: 速度为零问题诊断

```
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][DECIDE] current_vel=0.050, min_vel=0.300, decided_vel=0.300, path_points=25
[INFO] [goal_planner]: [VEL_DEBUG][GoalPlanner][MODIFY] Modified 25/25 points velocity
[INFO] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path: points=25, first_vel=0.000 m/s, last_vel=0.000 m/s
```

**分析**: 
- Goal Planner 决定速度为 0.3 m/s
- 但 BPP 输出却是 0.0 m/s
- **可能原因**: 后续模块（如 Obstacle Cruise）将速度设为 0
- **需要检查**: Obstacle Cruise 的日志，看是否有停止条件触发

---

## 🔍 典型调试流程

### 问题: 车辆速度为零

**步骤1**: 查看 BPP 输出
```bash
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]\[BPP\]\[PUBLISH\]"
```

**步骤2**: 查看 Goal Planner 决策
```bash
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]\[GoalPlanner\]"
```

**步骤3**: 查看 Obstacle Cruise 处理
```bash
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]\[ObstacleCruise\]"
```

**步骤4**: 查看避障影响
```bash
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]\[Avoidance\]"
```

**步骤5**: 使用速度链对比脚本
```bash
./compare_velocity_chain.sh
```

---

## 📁 相关文档

- **详细说明**: `添加速度调试日志说明.md`
- **车辆状态影响分析**: `车辆状态对Planning速度的影响分析.md`
- **BPP速度诊断**: `BPP速度为零_快速诊断.md`
- **近距离目标点分析**: `近距离目标点规划问题分析.md`

---

## ⚠️ 注意事项

### 1. 性能影响

- ✅ 所有日志都使用 `THROTTLE`，每秒最多输出一次
- ✅ DEBUG 日志仅在设置日志级别后才输出
- ✅ 对性能影响极小（< 1%）

### 2. 编译要求

- 需要重新编译 4 个包
- 建议使用 `RelWithDebInfo` 模式，保留调试符号
- 编译时间约 2-5 分钟

### 3. 日志存储

- 日志会保存在 `~/.ros/log/` 目录
- 长时间运行会产生大量日志文件
- 建议定期清理或使用 `logrotate`

---

## 🎯 预期效果

添加日志后，您可以：

1. ✅ **实时追踪速度传递**: 从 BPP 到 Control 的完整路径
2. ✅ **快速定位问题**: 找出哪个模块导致速度异常
3. ✅ **理解速度逻辑**: 了解各模块如何计算和修改速度
4. ✅ **验证参数调整**: 确认参数修改的实际效果
5. ✅ **诊断零速度**: 精确定位速度为零的根本原因

---

## 📈 后续建议

### 1. 如需更详细的日志

可以添加更多 DEBUG 级别日志，记录：
- 每个路径点的速度值
- 中间计算过程
- 参数使用情况

### 2. 如需性能分析

可以结合：
- `autoware_utils::ScopedTimeTrack` (已存在)
- 速度计算时间统计
- 模块处理延迟

### 3. 如需可视化

可以：
- 使用 PlotJuggler 绘制速度曲线
- 在 RViz 中用颜色显示速度
- 导出日志数据进行离线分析

---

## ✅ 总结

| 项目 | 状态 |
|------|------|
| 代码修改 | ✅ 完成 |
| 监控脚本 | ✅ 完成 |
| 对比脚本 | ✅ 完成 |
| 文档说明 | ✅ 完成 |
| 测试验证 | ⏳ 需要编译后测试 |

**下一步**: 
1. 编译修改的包
2. 启动 Autoware
3. 运行监控脚本
4. 验证日志输出

祝调试顺利！🚀

