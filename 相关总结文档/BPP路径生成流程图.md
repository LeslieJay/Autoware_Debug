# Behavior Path Planner 路径生成流程图

## 🎯 完整数据流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        输入数据 (PlannerData)                             │
├─────────────────────────────────────────────────────────────────────────┤
│  • 车辆状态 (self_odometry)                                              │
│  • Lanelet地图 (route_handler)                                          │
│  • 障碍物信息 (dynamic_object)                                           │
│  • 目标点 (route)                                                        │
│  • 交通灯状态 (traffic_light_id_map)                                     │
└────────────────────────────┬────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                  步骤1: 生成参考路径 (Reference Path)                     │
├─────────────────────────────────────────────────────────────────────────┤
│  getReferencePath(current_route_lanelet, data)                          │
│    ↓                                                                     │
│  getCenterLinePath()                                                    │
│    ↓                                                                     │
│  route_handler.getCenterLinePath()                                      │
│    ↓                                                                     │
│  ⭐ 从Lanelet读取speed_limit并设置到路径点                               │
│    traffic_rules_ptr_->speedLimit(lanelet).speedLimit.value()          │
│    p.point.longitudinal_velocity_mps = speed_limit                      │
│                                                                          │
│  输出: PathWithLaneId                                                    │
│    - points[].point.longitudinal_velocity_mps = 地图速度限制 (如30km/h)  │
│    - lane_ids[] = 车道ID列表                                            │
└────────────────────────────┬────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      Slot管道处理开始                                     │
└─────────────────────────────────────────────────────────────────────────┘
                             ↓
╔═════════════════════════════════════════════════════════════════════════╗
║                       Slot 1: Start Planner                             ║
╠═════════════════════════════════════════════════════════════════════════╣
║  功能: 车辆启动规划                                                      ║
║                                                                          ║
║  if (车辆静止 && 需要启动) {                                             ║
║    // 生成启动路径                                                       ║
║    output.path = generatePullOutPath();                                 ║
║    // 设置启动速度曲线 (0 → 目标速度)                                    ║
║  } else {                                                                ║
║    // 车辆已运动，直接传递输入路径                                        ║
║    output.path = input.path;                                            ║
║  }                                                                       ║
║                                                                          ║
║  输出传递给 → Slot 2                                                     ║
╚═════════════════════════════════════════════════════════════════════════╝
                             ↓
╔═════════════════════════════════════════════════════════════════════════╗
║                  Slot 2: 避障和换道模块集群                              ║
╠═════════════════════════════════════════════════════════════════════════╣
║  包含模块:                                                               ║
║    • Static Obstacle Avoidance (静态避障)                               ║
║    • Lane Change Left/Right (左右换道)                                  ║
║    • Side Shift (侧移)                                                  ║
║    • Avoidance by Lane Change (通过换道避障)                            ║
║    • External Request Lane Change (外部请求换道)                         ║
║                                                                          ║
║  ┌──────────────────────────────────────────────────────────────┐      ║
║  │  处理流程:                                                    │      ║
║  │                                                               │      ║
║  │  1️⃣ Approved Stack (串行执行)                                │      ║
║  │     ┌─────────────────────────────────────────┐             │      ║
║  │     │ 已批准的模块按顺序修改路径               │             │      ║
║  │     │                                          │             │      ║
║  │     │ Input Path                               │             │      ║
║  │     │   ↓                                      │             │      ║
║  │     │ Module A (Static Avoidance) → Path A    │             │      ║
║  │     │   ↓                                      │             │      ║
║  │     │ Module B (Lane Change) → Path B         │             │      ║
║  │     │   ↓                                      │             │      ║
║  │     │ Output Path                              │             │      ║
║  │     └─────────────────────────────────────────┘             │      ║
║  │                                                               │      ║
║  │  2️⃣ Candidate Stack (并行执行)                              │      ║
║  │     ┌─────────────────────────────────────────┐             │      ║
║  │     │ 候选模块并行生成候选路径                 │             │      ║
║  │     │                                          │             │      ║
║  │     │ Approved Output (同一输入)               │             │      ║
║  │     │   ├→ Module X → Candidate Path X        │             │      ║
║  │     │   ├→ Module Y → Candidate Path Y        │             │      ║
║  │     │   └→ Module Z → Candidate Path Z        │             │      ║
║  │     │                                          │             │      ║
║  │     │ 批准后移到Approved Stack                 │             │      ║
║  │     └─────────────────────────────────────────┘             │      ║
║  └──────────────────────────────────────────────────────────────┘      ║
║                                                                          ║
║  典型场景示例:                                                           ║
║  ┌────────────────────────────────────────────────────────────┐        ║
║  │ 场景: 遇到路边停车车辆                                      │        ║
║  │                                                             │        ║
║  │ 输入: 速度 8.33 m/s (30 km/h)                              │        ║
║  │   ↓                                                         │        ║
║  │ Static Obstacle Avoidance 检测到障碍物                      │        ║
║  │   ↓                                                         │        ║
║  │ 生成避障路径:                                               │        ║
║  │   • 横向偏移 1.5m 绕过障碍物                                │        ║
║  │   • 修改速度: 接近时减速到 4.0 m/s                          │        ║
║  │   • 通过后恢复到 8.33 m/s                                   │        ║
║  │   ↓                                                         │        ║
║  │ 输出: 避障路径，速度平滑过渡                                │        ║
║  └────────────────────────────────────────────────────────────┘        ║
║                                                                          ║
║  输出传递给 → Slot 3                                                     ║
╚═════════════════════════════════════════════════════════════════════════╝
                             ↓
╔═════════════════════════════════════════════════════════════════════════╗
║                     Slot 3: Goal Planner                                ║
╠═════════════════════════════════════════════════════════════════════════╣
║  功能: 目标点停车规划                                                    ║
║                                                                          ║
║  distance_to_goal = calculateDistanceToGoal();                          ║
║                                                                          ║
║  if (distance_to_goal < 20.0m) {                                        ║
║    // 接近目标点，开始停车规划                                           ║
║    auto parking_path = generateParkingPath();                           ║
║                                                                          ║
║    for (auto & point : parking_path.points) {                           ║
║      double dist = calcDistanceToGoal(point);                           ║
║                                                                          ║
║      if (dist > 10.0m) {                                                ║
║        // 10-20m: 正常速度                                              ║
║        point.velocity = input_velocity;                                 ║
║      } else if (dist > 5.0m) {                                          ║
║        // 5-10m: 线性减速                                               ║
║        point.velocity = lerp(input_velocity, 0.0, dist);                ║
║      } else {                                                            ║
║        // <5m: 停车区域                                                 ║
║        point.velocity = 0.0;  ⭐ 设置为0                                ║
║      }                                                                   ║
║    }                                                                     ║
║                                                                          ║
║    output.path = parking_path;                                          ║
║  } else {                                                                ║
║    // 距离目标点远，直接传递                                             ║
║    output.path = input.path;                                            ║
║  }                                                                       ║
║                                                                          ║
║  输出传递给 → Slot 4                                                     ║
╚═════════════════════════════════════════════════════════════════════════╝
                             ↓
╔═════════════════════════════════════════════════════════════════════════╗
║                  Slot 4: Dynamic Obstacle Avoidance                     ║
╠═════════════════════════════════════════════════════════════════════════╣
║  功能: 动态障碍物避障 (默认禁用)                                         ║
║                                                                          ║
║  if (enabled && hasDynamicObstacles()) {                                ║
║    output.path = generateDynamicAvoidancePath(input.path);              ║
║  } else {                                                                ║
║    output.path = input.path;                                            ║
║  }                                                                       ║
║                                                                          ║
║  输出 → 最终路径                                                         ║
╚═════════════════════════════════════════════════════════════════════════╝
                             ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                    步骤2: 路径后处理                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  1. 路径重采样 (resamplePathWithSpline)                                  │
│     • 按 output_path_interval (2.0m) 重采样                             │
│     • 速度插值保持连续性                                                 │
│                                                                          │
│  2. 路径裁剪 (cropPoints)                                                │
│     • 保留前方 forward_path_length (300m)                               │
│     • 保留后方 backward_path_length (5m)                                │
│                                                                          │
│  3. 路径验证                                                             │
│     • 检查路径点数量                                                     │
│     • 检查路径连续性                                                     │
└────────────────────────────┬────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                    步骤3: 发布最终路径                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  path_publisher_->publish(*resampled_path);                             │
│                                                                          │
│  话题: /planning/scenario_planning/lane_driving/                        │
│        behavior_planning/path_with_lane_id                              │
│                                                                          │
│  消息类型: autoware_planning_msgs/msg/PathWithLaneId                    │
│                                                                          │
│  内容:                                                                   │
│    header:                                                               │
│      stamp: ...                                                          │
│      frame_id: "map"                                                     │
│    points:                                                               │
│      - lane_ids: [12345, 12346]                                         │
│        point:                                                            │
│          pose: ...                                                       │
│          longitudinal_velocity_mps: 8.333333  # 速度 (m/s)              │
│          lateral_velocity_mps: 0.0                                       │
│      - lane_ids: [12346]                                                │
│        point:                                                            │
│          pose: ...                                                       │
│          longitudinal_velocity_mps: 8.333333                            │
│          ...                                                             │
│    left_bound: [...]                                                     │
│    right_bound: [...]                                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 速度修改的关键节点

```
┌───────────────────────────────────────────────────────────────────┐
│  速度来源和修改追踪                                                │
└───────────────────────────────────────────────────────────────────┘

1️⃣ 初始速度设置
┌─────────────────────────────────────────────────────────────┐
│ route_handler.getCenterLinePath()                           │
│                                                              │
│ const float speed_limit =                                   │
│   traffic_rules_ptr_->speedLimit(lanelet).speedLimit.value()│
│                                                              │
│ p.point.longitudinal_velocity_mps = speed_limit;            │
│                                                              │
│ ⭐ 速度来源: Lanelet地图的speed_limit标签 (km/h → m/s)       │
│ ⚠️  如果地图没有设置speed_limit，这里的值是0或无效值！        │
└─────────────────────────────────────────────────────────────┘
   初始速度: 例如 8.33 m/s (30 km/h)
   ↓
   
2️⃣ Start Planner可能修改
┌─────────────────────────────────────────────────────────────┐
│ 如果车辆从静止启动                                           │
│ - 生成启动速度曲线: 0 → 目标速度                            │
│ - 平滑加速                                                   │
└─────────────────────────────────────────────────────────────┘
   启动场景速度: 0 → 2 → 4 → 6 → 8.33 m/s
   ↓
   
3️⃣ Static Obstacle Avoidance可能修改
┌─────────────────────────────────────────────────────────────┐
│ 如果检测到静态障碍物                                         │
│ - 接近障碍物: 减速到安全速度 (如 4.0 m/s)                   │
│ - 避障区域: 保持低速                                         │
│ - 通过后: 恢复到原速度                                       │
└─────────────────────────────────────────────────────────────┘
   避障区域速度: 8.33 → 6 → 4 → 4 → 6 → 8.33 m/s
   ↓
   
4️⃣ Lane Change可能修改
┌─────────────────────────────────────────────────────────────┐
│ 如果执行换道                                                 │
│ - 根据换道曲率调整速度                                       │
│ - 曲率大: 降低速度                                           │
│ - 换道完成: 恢复速度                                         │
└─────────────────────────────────────────────────────────────┘
   换道速度: 8.33 → 6 (换道中) → 8.33 m/s
   ↓
   
5️⃣ Goal Planner可能修改
┌─────────────────────────────────────────────────────────────┐
│ 如果接近目标点 (< 20m)                                       │
│                                                              │
│ distance_to_goal:                                            │
│   > 10m: 保持速度 (8.33 m/s)                                │
│   5-10m: 线性减速 (8.33 → 0 m/s)                            │
│   < 5m:  速度为0 ⭐⭐⭐                                        │
│                                                              │
│ for (auto & point : path.points) {                          │
│   if (distance_to_goal < 5.0) {                             │
│     point.velocity = 0.0;  // 停车                          │
│   }                                                          │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘
   目标点附近速度: 8.33 → 6 → 4 → 2 → 0 m/s
   ↓
   
6️⃣ 路径重采样保持速度
┌─────────────────────────────────────────────────────────────┐
│ resamplePathWithSpline()                                     │
│ - 按新的采样间隔重新采样路径点                               │
│ - 速度通过插值保持连续                                       │
│ - 保留停止点的速度=0                                         │
└─────────────────────────────────────────────────────────────┘
   最终速度: 平滑插值的速度曲线
   ↓

最终输出: path_with_lane_id
```

---

## 📊 模块状态转换图

```
模块生命周期
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

      ┌──────────────┐
      │   IDLE       │  模块初始化，等待激活
      │  (空闲状态)   │
      └──────┬───────┘
             │
             │ 检测到需要执行的场景
             │ (例如：检测到障碍物需要避障)
             ↓
      ┌──────────────┐
      │  RUNNING     │  模块运行中
      │ (Candidate)  │  - 并行生成候选路径
      └──────┬───────┘  - 等待批准
             │
             │ RTC批准 或 自动批准
             │ (enable_rtc = false 时自动批准)
             ↓
      ┌──────────────┐
      │  RUNNING     │  模块运行中
      │ (Approved)   │  - 串行修改实际路径
      └──────┬───────┘  - 影响车辆行驶
             │
             │ 场景完成 或 失败
             │
       ┌─────┴──────┐
       ↓            ↓
┌────────────┐  ┌─────────────┐
│  SUCCESS   │  │   FAILURE   │
│ (任务完成)  │  │  (任务失败) │
└────────────┘  └─────────────┘
       │            │
       └────┬───────┘
            │
            ↓
     模块从栈中移除


批准流程细节
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

if (enable_rtc == true) {
    ┌──────────────────────────────┐
    │  需要外部RTC批准              │
    │                              │
    │  1. 模块生成候选路径          │
    │  2. 发布CooperateStatus       │
    │  3. 等待CooperateCommands批准 │
    │  4. 收到批准后移到Approved    │
    └──────────────────────────────┘
} else {
    ┌──────────────────────────────┐
    │  自动批准                     │
    │                              │
    │  1. 模块生成候选路径          │
    │  2. 自动移到Approved Stack   │
    │  3. 立即开始修改实际路径      │
    └──────────────────────────────┘
}
```

---

## 🎬 实际运行示例

### 示例1：正常行驶无干扰

```
时间轴: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━→

t=0: Reference Path
     速度: 8.33 m/s (来自地图)
     lane_ids: [100, 101, 102, ...]
     
t=1: Slot 1 (Start Planner)
     检查: 车辆已运动 → SKIP
     输出: 不变
     
t=2: Slot 2 (避障/换道)
     Static Avoidance: 无障碍物 → IDLE
     Lane Change: 无需换道 → IDLE
     输出: 不变
     
t=3: Slot 3 (Goal Planner)
     distance_to_goal: 150m > 20m → SKIP
     输出: 不变
     
t=4: Slot 4 (Dynamic Avoidance)
     模块禁用 → SKIP
     输出: 不变

最终输出: 
     速度保持 8.33 m/s
     路径沿centerline
     ✅ 正常行驶
```

### 示例2：遇到障碍物避障

```
时间轴: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━→

t=0: Reference Path
     速度: 8.33 m/s
     lane_ids: [100, 101, 102, ...]
     
t=1: Slot 1 → SKIP

t=2: Slot 2
     ┌────────────────────────────────────┐
     │ Static Obstacle Avoidance          │
     ├────────────────────────────────────┤
     │ 检测: 前方50m处有停车车辆           │
     │ 状态: IDLE → RUNNING (Candidate)   │
     │ 动作:                              │
     │   - 生成候选避障路径               │
     │   - 横向偏移1.5m                   │
     │   - 接近时减速到4.0 m/s            │
     │ 批准: 自动批准                     │
     │ 状态: Candidate → Approved         │
     └────────────────────────────────────┘
     
     输出路径:
       30-40m: 速度 8.33 → 6.0 m/s (减速)
       40-50m: 速度 6.0 → 4.0 m/s (接近障碍物)
       50-60m: 速度 4.0 m/s (避障区域)
       60-70m: 速度 4.0 → 8.33 m/s (加速)
     
t=3: Slot 3 → SKIP (距离goal远)

t=4: Slot 4 → SKIP

最终输出:
     路径横向偏移绕过障碍物
     速度平滑减速-恢复
     ✅ 安全避障
```

### 示例3：接近目标点停车

```
时间轴: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━→

t=0: Reference Path
     速度: 8.33 m/s
     lane_ids: [100, 101, 102, 103 (goal)]
     
t=1: Slot 1 → SKIP

t=2: Slot 2 → SKIP (无障碍物)

t=3: Slot 3
     ┌────────────────────────────────────┐
     │ Goal Planner                       │
     ├────────────────────────────────────┤
     │ 检测: distance_to_goal = 15m       │
     │ 状态: IDLE → RUNNING (Approved)    │
     │ 动作: 生成停车路径                 │
     │                                    │
     │ 速度设置:                          │
     │   10-15m: 8.33 m/s (正常)         │
     │   5-10m:  8.33 → 0 (线性减速)     │
     │   0-5m:   0.0 m/s ⭐ (停车区域)    │
     └────────────────────────────────────┘
     
     输出路径:
       point[0] (15m): velocity = 8.33 m/s
       point[1] (12m): velocity = 8.33 m/s
       point[2] (10m): velocity = 6.67 m/s
       point[3] (8m):  velocity = 5.00 m/s
       point[4] (6m):  velocity = 3.33 m/s
       point[5] (4m):  velocity = 1.67 m/s
       point[6] (2m):  velocity = 0.83 m/s
       point[7] (0m):  velocity = 0.00 m/s ⭐
     
t=4: Slot 4 → SKIP

最终输出:
     路径终点在goal位置
     速度平滑减速到0
     ✅ 停车成功
```

---

## 🔍 调试检查点

```
检查点1: 参考路径生成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 检查地图是否加载
✓ 检查traffic_rules是否初始化
✓ 检查speed_limit是否从地图读取
  → ros2 topic echo /planning/.../debug/reference_path

检查点2: Slot 1 输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 检查start_planner状态
  → ros2 topic echo /.../debug/scene_module_status | grep start

检查点3: Slot 2 输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 检查避障模块状态
✓ 检查换道模块状态
  → ros2 topic echo /.../debug/scene_module_status

检查点4: Slot 3 输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 检查goal_planner状态
✓ 检查距离目标点距离
✓ 检查是否有"out of route"警告
  → ros2 topic echo /rosout | grep "out of route"

检查点5: 最终输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 检查最终路径速度分布
  → ./debug_bpp_velocity.sh
  → ros2 topic echo /planning/behavior_planning/path_with_lane_id
```

---

## 📚 相关文档

- [详细设计文档](./behavior_path_planner场景模块工作原理详解.md)
- [速度为零问题分析](./behavior_path_planner速度为零的原因分析.md)
- [快速诊断指南](./BPP速度为零_快速诊断.md)

---

**总结：** `path_with_lane_id` 是经过4个Slot串行处理后的最终结果，每个Slot内的模块根据场景需求修改路径和速度。初始速度来自lanelet地图的speed_limit，最终速度可能被场景模块（特别是Goal Planner）修改。

