# 近距离目标点规划问题分析

## 📋 问题概述

### 问题1: 目标点距离起点较近的影响

**答案：是的，会有显著影响！**

当目标点距离起点过近时，会导致以下问题：

1. **路径规划失败** - 无法生成有效路径
2. **速度被强制为0** - 目标点附近速度必须为0
3. **Goal Planner无法激活** - 距离不满足最小要求
4. **减速距离不足** - 无法安全停车

---

## 🔍 详细分析

### 1. Goal Planner的距离检查机制

#### 关键代码位置
**文件：** `goal_planner_module.cpp::isExecutionRequested()`

```cpp
// 865-873行：检查到目标点的距离
const double self_to_goal_arc_length =
  utils::getSignedDistance(current_pose, goal_pose, current_lanes);

const double request_length = utils::isAllowedGoalModification(route_handler)
                                ? calcModuleRequestLength()
                                : parameters_.pull_over_minimum_request_length;

if (self_to_goal_arc_length < 0.0 || self_to_goal_arc_length > request_length) {
  // 如果距离太近或太远，goal_planner不执行
  return false;
}
```

**重要参数：**
```yaml
# goal_planner.param.yaml
pull_over:
  minimum_request_length: 0.0  # 最小请求长度（默认0，但实际需要更大）
  pull_over_prepare_length: 100.0  # 准备停车的长度
  decide_path_distance: 10.0  # 决定路径的距离
```

---

### 2. 距离不足时的问题

#### A. 无法生成Pull Over路径

```cpp
// 2093-2129行：检查是否有足够距离
bool GoalPlannerModule::hasEnoughDistance(
  const PullOverPath & pull_over_path, 
  const PathWithLaneId & long_tail_reference_path) const
{
  const Pose & current_pose = planner_data_->self_odometry->pose.pose;
  const double current_vel = planner_data_->self_odometry->twist.twist.linear.x;

  // 检查1: 分段路径且已停止时，需要重启距离
  const bool is_separated_path = pull_over_path.partial_paths().size() > 1;
  const double distance_to_start = calcSignedArcLength(
    long_tail_reference_path.points, current_pose.position, 
    pull_over_path.start_pose().position);
  const double distance_to_restart = parameters_.decide_path_distance / 2;  // 5.0m
  const double eps_vel = 0.01;
  const bool is_stopped = std::abs(current_vel) < eps_vel;
  
  if (is_separated_path && is_stopped && distance_to_start < distance_to_restart) {
    // ❌ 距离不足5m，无法重启
    return false;
  }

  // 检查2: 计算安全减速距离
  const auto current_to_stop_distance = calcFeasibleDecelDistance(
    planner_data_, 
    parameters_.maximum_deceleration,  // 1.0 m/s²
    parameters_.maximum_jerk,          // 1.0 m/s³
    0.0
  );

  const double buffer = is_stopped ? stop_distance_buffer_ : 0.0;
  if (distance_to_start + buffer < *current_to_stop_distance) {
    // ❌ 距离不足，无法安全减速
    return false;
  }

  return true;
}
```

**距离计算示例：**
```
假设当前速度 = 5 m/s (18 km/h)
最大减速度 = 1.0 m/s²
最大加加速度 = 1.0 m/s³

需要的最小安全停车距离 ≈ 12.5m

如果目标点距离 < 12.5m → 路径规划失败！
```

---

#### B. 目标点附近速度必须为0

**代码位置：** `utils.cpp::set_goal()`

```cpp
// 244-292行：设置目标点
bool set_goal(
  const double search_radius_range, 
  const PathWithLaneId & input, 
  const Pose & goal,
  PathWithLaneId * output_ptr)
{
  // 计算refined_goal
  PathPointWithLaneId refined_goal{};
  refined_goal.point.pose = goal;
  
  // ⚠️ 关键：目标点速度强制设为0
  refined_goal.point.longitudinal_velocity_mps = 0.0;
  
  // 计算pre_refined_goal（目标点前1米）
  PathPointWithLaneId pre_refined_goal{};
  constexpr double goal_to_pre_goal_distance = -1.0;
  pre_refined_goal.point.pose = 
    autoware_utils::calc_offset_pose(goal, goal_to_pre_goal_distance, 0.0, 0.0);
  
  // pre_goal的速度从路径插值获得
  pre_refined_goal.point.longitudinal_velocity_mps =
    calcInterpolatedVelocity(input, closest_seg_idx_for_pre_goal);
  
  // 构建输出路径
  // ...
}
```

**影响：**
```
目标点位置：速度 = 0 m/s（强制）
目标点 -1m：速度 = 插值速度（可能较低）
目标点 -2m：速度开始减速
...

如果总距离 < 10m，整个路径都在减速区
→ 平均速度极低
→ 效率很差
```

---

### 3. 速度为0的情况

#### 场景A：目标点本身

```cpp
// 目标点速度永远是0
refined_goal.point.longitudinal_velocity_mps = 0.0;
```

#### 场景B：路径太短

```cpp
// behavior_path_planner.param.yaml
forward_path_length: 300.0  # 向前路径长度

// 如果起点到终点距离 < 10m
// 而forward_path_length = 300m
// 会生成很多填充点，这些点可能速度为0
```

#### 场景C：无有效车道信息

```cpp
// path_utils.cpp::getReferencePath()
// 如果距离太短，无法获取有效车道
// 可能返回零速度路径

for (auto & point : reference_path.points) {
  point.point.longitudinal_velocity_mps = 0.0;  // 无效路径
}
```

---

## 🎯 距离阈值总结

### 关键距离参数

| 参数名称 | 默认值 | 说明 | 影响 |
|---------|--------|------|------|
| **th_arrived_distance** | 1.0 m | 判断到达目标的距离 | < 1m认为已到达 |
| **decide_path_distance** | 10.0 m | 决定pull over路径的距离 | 需要≥5m重启距离 |
| **pull_over_minimum_request_length** | 0.0 m | 最小请求长度 | 建议设为≥15m |
| **pull_over_prepare_length** | 100.0 m | pull over准备长度 | 理想情况下的距离 |
| **backward_path_length** | 5.0 m | 向后路径长度 | 起点前缓冲 |
| **forward_path_length** | 300.0 m | 向前路径长度 | 终点后扩展 |
| **goal_search_forward** | 40.0 m | 向前搜索目标范围 | 目标点搜索 |
| **goal_search_backward** | 20.0 m | 向后搜索目标范围 | 目标点搜索 |

### 推荐最小距离

```
┌─────────────────────────────────────────────────────────────┐
│ 场景                    │ 最小距离    │ 推荐距离          │
├─────────────────────────┼─────────────┼───────────────────┤
│ 低速（< 2 m/s）         │ 5 m         │ 10-15 m          │
│ 中速（2-5 m/s）         │ 15 m        │ 20-30 m          │
│ 高速（> 5 m/s）         │ 30 m        │ 50+ m            │
│                         │             │                   │
│ 室内AGV（低速）         │ 3 m         │ 5-10 m           │
│ 室内AGV（正常）         │ 5 m         │ 10-15 m          │
└─────────────────────────┴─────────────┴───────────────────┘
```

---

## 🏭 室内AGV配置建议

### 配置哲学

室内AGV与室外车辆的主要区别：
1. **速度慢** - 通常 < 2 m/s (7.2 km/h)
2. **空间小** - 走廊宽度有限
3. **频繁停车** - 目标点密集
4. **精确定位** - 到达精度要求高
5. **无交通规则** - 不需要车道保持、换道等

---

### 1. Behavior Planner 主配置

**文件：** `behavior_path_planner.param.yaml`

```yaml
/**:
  ros__parameters:
    # ========== 规划频率 ==========
    planning_hz: 10.0  # 室内AGV可以保持10Hz，或降低到5Hz节省资源
    
    # ========== 路径长度配置 ==========
    # ⚠️ 关键：大幅缩短路径长度
    backward_path_length: 2.0        # 默认5.0 → 2.0m（室内空间小）
    forward_path_length: 30.0        # 默认300.0 → 30.0m（不需要看太远）
    
    # Pull Over相关
    backward_length_buffer_for_end_of_pull_over: 2.0   # 默认5.0 → 2.0m
    backward_length_buffer_for_end_of_pull_out: 2.0    # 默认5.0 → 2.0m
    minimum_pull_over_length: 5.0                      # 默认16.0 → 5.0m
    
    # 目标搜索半径
    refine_goal_search_radius_range: 3.0  # 默认7.5 → 3.0m（提高精度）
    
    # ========== 转向灯配置（AGV可能不需要）==========
    turn_signal_intersection_search_distance: 5.0   # 默认30.0 → 5.0m
    turn_signal_minimum_search_distance: 3.0        # 默认10.0 → 3.0m
    turn_signal_search_time: 1.0                    # 默认3.0 → 1.0s
    turn_signal_shift_length_threshold: 0.1         # 默认0.3 → 0.1m
    
    # ========== 路径间隔 ==========
    input_path_interval: 0.5          # 默认2.0 → 0.5m（更密集，更平滑）
    output_path_interval: 0.5         # 默认2.0 → 0.5m
```

---

### 2. Goal Planner 配置

**文件：** `goal_planner.param.yaml`

```yaml
/**:
  ros__parameters:
    goal_planner:
      # ========== 到达判断 ==========
      th_arrived_distance: 0.3        # 默认1.0 → 0.3m（AGV需要更精确）
      th_stopped_velocity: 0.01       # 保持0.01 m/s
      th_stopped_time: 1.0            # 默认2.0 → 1.0s（快速响应）
      
      center_line_path_interval: 0.5  # 默认1.0 → 0.5m
      
      # ========== 目标搜索 ==========
      goal_search:
        goal_priority: "minimum_weighted_distance"
        minimum_weighted_distance:
          lateral_weight: 20.0        # 默认40.0 → 20.0（降低横向权重）
        
        prioritize_goals_before_objects: true
        parking_policy: "left_side"   # 或根据AGV习惯选择
        
        # ⚠️ 关键：大幅缩短搜索范围
        forward_goal_search_length: 10.0   # 默认40.0 → 10.0m
        backward_goal_search_length: 5.0   # 默认20.0 → 5.0m
        
        goal_search_interval: 0.5          # 默认2.0 → 0.5m（更密集搜索）
        longitudinal_margin: 1.0           # 默认3.0 → 1.0m
        max_lateral_offset: 0.5            # 默认1.0 → 0.5m（走廊窄）
        lateral_offset_interval: 0.2       # 默认0.5 → 0.2m
        
        margin_from_boundary: 0.3          # 默认0.75 → 0.3m
        high_curvature_threshold: 0.2      # 默认0.1 → 0.2（允许更弯曲）
      
      # ========== 占用栅格地图 ==========
      occupancy_grid:
        use_occupancy_grid_for_goal_search: true
        use_occupancy_grid_for_path_collision_check: true  # 室内建议启用
        occupancy_grid_collision_check_margin: 0.1         # 默认0.0 → 0.1m
        theta_size: 360
        obstacle_threshold: 60
      
      # ========== 障碍物识别 ==========
      object_recognition:
        # ⚠️ 室内AGV可能只关心人
        collision_check_soft_margins: [2.0, 1.5, 1.0, 0.5]  # 简化margin
        collision_check_hard_margins: [0.3]                 # 默认0.6 → 0.3m
        
        object_recognition_collision_check_max_extra_stopping_margin: 0.5  # 默认1.0 → 0.5m
        
        th_moving_object_velocity: 0.5      # 默认1.0 → 0.5 m/s（室内物体慢）
        detection_bound_offset: 5.0         # 默认15.0 → 5.0m
        outer_road_detection_offset: 0.5    # 默认1.0 → 0.5m
      
      # ========== Pull Over配置 ==========
      pull_over:
        # ⚠️ 关键：调整到AGV尺度
        minimum_request_length: 5.0         # 默认0.0 → 5.0m（必须设置！）
        pull_over_prepare_length: 15.0      # 默认100.0 → 15.0m
        
        # 速度配置
        pull_over_velocity: 0.8             # 默认3.0 → 0.8 m/s（慢速接近）
        pull_over_minimum_velocity: 0.5     # 默认1.38 → 0.5 m/s
        
        decide_path_distance: 3.0           # 默认10.0 → 3.0m
        
        # 动力学参数（AGV通常较平缓）
        maximum_deceleration: 0.5           # 默认1.0 → 0.5 m/s²
        maximum_jerk: 0.5                   # 默认1.0 → 0.5 m/s³
        
        path_priority: "close_goal"         # 默认"efficient_path" → "close_goal"
        efficient_path_order: ["SHIFT"]     # 室内AGV只用简单shift
        
        lane_departure_check_expansion_margin: 0.1  # 默认0.2 → 0.1m
        
        # ========== Shift Parking ==========
        shift_parking:
          enable_shift_parking: true
          shift_sampling_num: 2             # 默认4 → 2（减少计算）
          maximum_lateral_jerk: 1.0         # 默认2.0 → 1.0
          minimum_lateral_jerk: 0.3         # 默认0.5 → 0.3
          deceleration_interval: 5.0        # 默认15.0 → 5.0m
          after_shift_straight_distance: 0.5  # 默认1.0 → 0.5m
        
        # ========== Parallel Parking（可选禁用）==========
        parallel_parking:
          max_steer_angle_margin_scale: 0.72
          forward:
            enable_arc_forward_parking: false    # 室内AGV通常不需要
          backward:
            enable_arc_backward_parking: false   # 室内AGV通常不需要
        
        # ========== Freespace Parking（可能需要）==========
        freespace_parking:
          enable_freespace_parking: true     # 如果需要避障导航
          freespace_parking_algorithm: "astar"
          velocity: 0.5                      # 默认1.0 → 0.5 m/s
          vehicle_shape_margin: 0.3          # 默认1.0 → 0.3m（减小margin）
          time_limit: 1500.0                 # 默认3000.0 → 1500ms
          
          search_configs:
            theta_size: 72                   # 默认120 → 72（减少计算）
            angle_goal_range: 10.0           # 默认6.0 → 10.0（更宽容）
            lateral_goal_range: 0.3          # 默认0.5 → 0.3m
            longitudinal_goal_range: 1.0     # 默认2.0 → 1.0m
      
      # ========== 停止条件 ==========
      stop_condition:
        maximum_deceleration_for_stop: 0.5  # 默认1.0 → 0.5 m/s²
        maximum_jerk_for_stop: 0.5          # 默认1.0 → 0.5 m/s³
      
      # ========== 路径安全检查 ==========
      path_safety_check:
        ego_predicted_path:
          min_velocity: 0.5                 # 默认1.0 → 0.5 m/s
          min_acceleration: 0.5             # 默认1.0 → 0.5 m/s²
          max_velocity: 2.0                 # 默认1.0 → 2.0 m/s（AGV最大速度）
          time_horizon_for_front_object: 3.0  # 默认5.0 → 3.0s
          time_horizon_for_rear_object: 3.0   # 默认5.0 → 3.0s
          time_resolution: 0.5
          delay_until_departure: 0.5        # 默认1.0 → 0.5s
        
        target_filtering:
          safety_check_time_horizon: 3.0    # 默认5.0 → 3.0s
          object_check_forward_distance: 20.0   # 默认100.0 → 20.0m
          object_check_backward_distance: 10.0  # 默认100.0 → 10.0m
          ignore_object_velocity_threshold: 0.5  # 默认1.0 → 0.5 m/s
          
          # 室内AGV主要关心人
          object_types_to_check:
            check_car: false              # AGV通常不与车共存
            check_truck: false
            check_bus: false
            check_trailer: false
            check_bicycle: true           # 可能有
            check_motorcycle: false
            check_pedestrian: true        # ✓ 重要
            check_unknown: true           # ✓ 保守策略
        
        safety_check_params:
          enable_safety_check: true
          method: "integral_predicted_polygon"
          keep_unsafe_time: 0.3             # 默认0.5 → 0.3s
          
          rss_params:
            rear_vehicle_reaction_time: 1.0     # 默认2.0 → 1.0s
            rear_vehicle_safety_time_margin: 0.5  # 默认1.0 → 0.5s
            lateral_distance_max_threshold: 1.0   # 默认2.0 → 1.0m
            longitudinal_distance_min_threshold: 1.0  # 默认3.0 → 1.0m
          
          integral_predicted_polygon_params:
            forward_margin: 0.5             # 默认1.0 → 0.5m
            backward_margin: 0.3            # 默认1.0 → 0.3m
            lat_margin: 0.3                 # 默认1.0 → 0.3m
            time_horizon: 3.0               # 默认5.0 → 3.0s
          
          backward_path_length: 10.0        # 默认30.0 → 10.0m
          forward_path_length: 20.0         # 默认100.0 → 20.0m
```

---

### 3. 其他Scene Modules配置（可选禁用）

**文件：** `scene_module_manager.param.yaml`

```yaml
/**:
  ros__parameters:
    # ========== Slot配置 ==========
    # 室内AGV简化Slot结构
    slots:
      - slot1  # start
      - slot2  # goal
    
    # Slot 1: Start Planner（如果需要）
    slot1:
      - "start_planner"
    
    # Slot 2: Goal Planner（核心）
    slot2:
      - "goal_planner"
    
    # 禁用不需要的模块（注释掉或移除）
    # - "static_obstacle_avoidance"  # 可能不需要
    # - "lane_change_left"           # 室内AGV通常不换道
    # - "lane_change_right"
    # - "avoidance_by_lane_change"
    # - "side_shift"
    # - "dynamic_obstacle_avoidance"
    
    # ========== 模块使能配置 ==========
    start_planner:
      enable_module: true
      enable_simultaneous_execution_as_approved_module: false
      enable_simultaneous_execution_as_candidate_module: false
      priority: 0
      max_module_size: 1
    
    goal_planner:
      enable_module: true
      enable_simultaneous_execution_as_approved_module: false
      enable_simultaneous_execution_as_candidate_module: false
      enable_rtc: false  # AGV自动执行，不需要人工批准
      priority: 0
      max_module_size: 1
```

**文件：** `default_preset.yaml`

```yaml
# 禁用不需要的模块
launch:
  # 室内AGV通常不需要这些
  - arg:
      name: launch_static_obstacle_avoidance
      default: "false"  # 禁用
  - arg:
      name: launch_dynamic_obstacle_avoidance_module
      default: "false"  # 禁用
  - arg:
      name: launch_lane_change_left
      default: "false"  # 禁用
  - arg:
      name: launch_lane_change_right
      default: "false"  # 禁用
  - arg:
      name: launch_avoidance_by_lane_change
      default: "false"  # 禁用
  
  # 保留必要模块
  - arg:
      name: launch_goal_planner_module
      default: "true"   # 启用
  - arg:
      name: launch_start_planner_module
      default: "true"   # 启用（如果需要）
```

---

### 4. Start Planner 配置（如果需要）

**文件：** `start_planner.param.yaml`

```yaml
/**:
  ros__parameters:
    start_planner:
      th_arrived_distance: 0.3        # 默认1.0 → 0.3m
      th_stopped_velocity: 0.01
      th_stopped_time: 1.0            # 默认2.0 → 1.0s
      
      # AGV起步配置
      prepare_time_before_start: 1.0  # 默认不变
      th_distance_to_middle_of_the_road: 0.3  # 默认0.5 → 0.3m
      
      # 简化collision check（室内环境相对可控）
      collision_check_margins: [1.0, 0.5]  # 简化margin
      collision_check_distance_from_end: 5.0  # 默认不变或更小
      
      th_moving_object_velocity: 0.5  # 默认1.0 → 0.5 m/s
```

---

### 5. 车辆参数配置

**文件：** `vehicle_info.param.yaml`

```yaml
/**:
  ros__parameters:
    # ========== AGV物理尺寸 ==========
    # ⚠️ 根据实际AGV尺寸修改
    wheel_radius: 0.1                # 车轮半径 [m]
    wheel_width: 0.08                # 车轮宽度 [m]
    wheel_base: 0.8                  # 轴距 [m]（前后轮距离）
    wheel_tread: 0.6                 # 轮距 [m]（左右轮距离）
    front_overhang: 0.2              # 前悬 [m]
    rear_overhang: 0.2               # 后悬 [m]
    left_overhang: 0.1               # 左悬 [m]
    right_overhang: 0.1              # 右悬 [m]
    vehicle_height: 1.0              # 车高 [m]
    
    # 计算得出：
    # vehicle_length = wheel_base + front_overhang + rear_overhang = 1.2m
    # vehicle_width = wheel_tread + left_overhang + right_overhang = 0.8m
    
    # ========== 安全裕度 ==========
    max_steer_angle: 0.7             # 最大转向角 [rad]（约40度）
```

---

## 📊 配置对比表

### 关键参数对比

| 参数 | 室外车辆 | 室内AGV | 变化 |
|-----|---------|---------|------|
| **路径长度** |
| forward_path_length | 300.0 m | 30.0 m | ⬇️ 90% |
| backward_path_length | 5.0 m | 2.0 m | ⬇️ 60% |
| **目标搜索** |
| forward_goal_search | 40.0 m | 10.0 m | ⬇️ 75% |
| backward_goal_search | 20.0 m | 5.0 m | ⬇️ 75% |
| goal_search_interval | 2.0 m | 0.5 m | ⬇️ 75% |
| **到达精度** |
| th_arrived_distance | 1.0 m | 0.3 m | ⬆️ 精度提高 |
| **速度** |
| pull_over_velocity | 3.0 m/s | 0.8 m/s | ⬇️ 73% |
| pull_over_min_velocity | 1.38 m/s | 0.5 m/s | ⬇️ 64% |
| **动力学** |
| maximum_deceleration | 1.0 m/s² | 0.5 m/s² | ⬇️ 50% |
| maximum_jerk | 1.0 m/s³ | 0.5 m/s³ | ⬇️ 50% |
| **距离阈值** |
| minimum_request_length | 0.0 m | 5.0 m | ⚠️ 必须设置 |
| decide_path_distance | 10.0 m | 3.0 m | ⬇️ 70% |
| pull_over_prepare_length | 100.0 m | 15.0 m | ⬇️ 85% |

---

## 🔧 实际使用建议

### 1. 设置目标点时的注意事项

```bash
# ❌ 错误：目标点太近
距离起点：3m
当前速度：2 m/s
→ 无法生成有效路径！

# ✅ 正确：室内AGV
距离起点：≥ 5m（静止状态）
距离起点：≥ 10m（移动状态，2 m/s）
当前速度：< 2 m/s
→ 可以正常规划

# ✅ 正确：室外车辆
距离起点：≥ 15m（低速）
距离起点：≥ 30m（中速）
距离起点：≥ 50m（高速）
```

### 2. 动态调整策略

根据当前速度动态计算最小目标距离：

```python
# 伪代码：计算最小安全距离
def calculate_min_goal_distance(current_velocity, max_decel, max_jerk):
    """
    计算到达目标点的最小安全距离
    """
    # 考虑减速距离
    t_jerk = current_velocity / max_jerk  # 加加速度时间
    t_decel = current_velocity / max_decel  # 减速时间
    
    # 两阶段减速距离
    d_jerk = 0.5 * max_jerk * t_jerk**2  # 加加速度阶段
    d_decel = current_velocity * t_decel - 0.5 * max_decel * t_decel**2  # 匀减速阶段
    
    # 总距离 + 安全裕度
    min_distance = d_jerk + d_decel + safety_margin
    
    return min_distance

# 示例计算
# AGV: v=2m/s, a=0.5m/s², j=0.5m/s³, margin=2m
min_dist_agv = calculate_min_goal_distance(2.0, 0.5, 0.5)
# → 约 6-8m

# 室外车辆: v=10m/s, a=1.0m/s², j=1.0m/s³, margin=5m
min_dist_vehicle = calculate_min_goal_distance(10.0, 1.0, 1.0)
# → 约 55-60m
```

### 3. 路径长度选择指南

```
┌─────────────────────────────────────────────────────────┐
│ 应用场景              │ forward_path_length            │
├─────────────────────────────────────────────────────────┤
│ 室内AGV（小房间）     │ 10-20 m                        │
│ 室内AGV（大仓库）     │ 20-50 m                        │
│ 室外低速车辆          │ 50-100 m                       │
│ 室外正常车辆          │ 100-300 m                      │
│ 高速公路              │ 300-500 m                      │
└─────────────────────────────────────────────────────────┘

原则：
  forward_path_length ≥ 2 × 最大目标距离
  forward_path_length ≥ 10 × 当前速度（秒）
```

---

## 🚀 快速配置脚本

### AGV配置检查脚本

```bash
#!/bin/bash
# check_agv_config.sh - 检查AGV配置是否合理

echo "=== AGV配置检查 ==="

# 检查路径长度
forward_path=$(rosparam get /planning/scenario_planning/lane_driving/behavior_planning/behavior_path_planner/forward_path_length)
echo "[1] forward_path_length: $forward_path m"
if (( $(echo "$forward_path > 50" | bc -l) )); then
  echo "  ⚠️  警告：对于AGV来说可能太长，建议20-30m"
fi

# 检查minimum_request_length
min_req=$(rosparam get /planning/.../goal_planner/pull_over/minimum_request_length)
echo "[2] minimum_request_length: $min_req m"
if (( $(echo "$min_req < 3" | bc -l) )); then
  echo "  ❌ 错误：太短！建议设置为5-10m"
fi

# 检查到达距离
arrived_dist=$(rosparam get /planning/.../goal_planner/th_arrived_distance)
echo "[3] th_arrived_distance: $arrived_dist m"
if (( $(echo "$arrived_dist > 0.5" | bc -l) )); then
  echo "  ⚠️  警告：对于AGV精度可能不够，建议0.2-0.3m"
fi

# 检查pull over速度
po_vel=$(rosparam get /planning/.../goal_planner/pull_over/pull_over_velocity)
echo "[4] pull_over_velocity: $po_vel m/s"
if (( $(echo "$po_vel > 1.5" | bc -l) )); then
  echo "  ⚠️  警告：对于AGV可能太快，建议0.5-1.0 m/s"
fi

echo ""
echo "=== 检查完成 ==="
```

---

## 📖 总结

### 问题回答

#### Q1: 目标点距离起点较近有影响吗？
**A:** **有显著影响！**
- 距离 < 减速所需最小距离 → 路径规划失败
- 距离 < `minimum_request_length` → Goal Planner不执行
- 距离 < `decide_path_distance/2` (静止时) → 无法重启

#### Q2: 会导致速度为0吗？
**A:** **会！**
- 目标点本身速度强制为0
- 目标点附近区域处于减速阶段
- 如果距离太短，整个路径都是减速区
- 无有效车道时，可能生成全零速度路径

#### Q3: 室内AGV如何配置？
**A:** **关键调整：**
1. **缩短路径长度**：300m → 30m
2. **提高到达精度**：1.0m → 0.3m
3. **降低速度**：3.0m/s → 0.8m/s
4. **减小动力学参数**：1.0m/s² → 0.5m/s²
5. **设置最小距离**：0m → 5m
6. **禁用不需要的模块**：换道、避障等
7. **调整安全margin**：大幅减小

### 最佳实践

```
✅ DO:
  - 设置目标点时检查当前速度
  - 确保距离 ≥ 2 × 减速距离
  - 为AGV使用专门配置
  - 测试最小可行距离
  - 监控路径规划失败率

❌ DON'T:
  - 使用默认配置于AGV
  - 设置过近的目标点（< 5m）
  - 忽略 minimum_request_length
  - 使用过大的 forward_path_length
  - 启用不需要的scene modules
```

---

**相关文档：**
- [behavior_path_planner场景模块工作原理详解.md](./behavior_path_planner场景模块工作原理详解.md)
- [behavior_path_planner速度为零的原因分析.md](./behavior_path_planner速度为零的原因分析.md)
- [VEHICLE_INFO_CONFIG_EXPLANATION.md](./VEHICLE_INFO_CONFIG_EXPLANATION.md)

