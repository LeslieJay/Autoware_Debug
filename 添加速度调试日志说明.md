# Planning æ¨¡å—é€Ÿåº¦è°ƒè¯•æ—¥å¿—æ·»åŠ è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨ Autoware Planning æ¨¡å—ä¸­æ·»åŠ  `longitudinal_velocity_mps` ç›¸å…³çš„è°ƒè¯•æ—¥å¿—ï¼Œä»¥ä¾¿è·Ÿè¸ªé€Ÿåº¦è®¡ç®—å’Œä¼ é€’è¿‡ç¨‹ã€‚

---

## ğŸ¯ å…³é”®æ–‡ä»¶å’Œä½ç½®

### 1. Behavior Path Planner (BPP) - æ ¸å¿ƒæ¨¡å—

#### æ–‡ä»¶: `behavior_path_planner_node.cpp`
**åŠŸèƒ½**: BPP ä¸»èŠ‚ç‚¹ï¼Œè¾“å‡ºæœ€ç»ˆè·¯å¾„

**å…³é”®ä½ç½®**:
- è·¯å¾„å‘å¸ƒå‰
- é€Ÿåº¦è®¾ç½®å

#### æ–‡ä»¶: `goal_planner_module.cpp`
**åŠŸèƒ½**: ç›®æ ‡ç‚¹è§„åˆ’ï¼Œè®¾ç½®åœè½¦é€Ÿåº¦

**å…³é”®ä½ç½®**:
- `decideVelocity()` - å†³å®šé€Ÿåº¦çš„å‡½æ•°
- è·¯å¾„ç”Ÿæˆåçš„é€Ÿåº¦è®¾ç½®

#### æ–‡ä»¶: `static_obstacle_avoidance_module.cpp`
**åŠŸèƒ½**: é™æ€éšœç¢ç‰©é¿è®©

**å…³é”®ä½ç½®**:
- `insertAvoidanceVelocity()` - æ’å…¥é¿éšœé€Ÿåº¦
- é€Ÿåº¦å¹³æ»‘å¤„ç†

---

### 2. Behavior Velocity Planner - åœºæ™¯é€Ÿåº¦è§„åˆ’

#### æ–‡ä»¶: `traffic_light_module/src/scene.cpp`
**åŠŸèƒ½**: çº¢ç»¿ç¯åœæ­¢çº¿é€Ÿåº¦æ§åˆ¶

#### æ–‡ä»¶: `crosswalk_module/src/scene_crosswalk.cpp`
**åŠŸèƒ½**: äººè¡Œæ¨ªé“é€Ÿåº¦æ§åˆ¶

#### æ–‡ä»¶: `intersection_module/src/scene_intersection_collision.cpp`
**åŠŸèƒ½**: è·¯å£é€Ÿåº¦æ§åˆ¶

---

### 3. Motion Velocity Planner - è¿åŠ¨é€Ÿåº¦è§„åˆ’

#### æ–‡ä»¶: `obstacle_cruise_module/src/pid_based_planner.cpp`
**åŠŸèƒ½**: åŸºäº PID çš„å·¡èˆªé€Ÿåº¦è§„åˆ’

#### æ–‡ä»¶: `obstacle_cruise_module/src/optimization_based_planner.cpp`
**åŠŸèƒ½**: åŸºäºä¼˜åŒ–çš„é€Ÿåº¦è§„åˆ’

---

### 4. Obstacle Cruise Planner - éšœç¢ç‰©å·¡èˆª

#### æ–‡ä»¶: `autoware_obstacle_cruise_planner/src/node.cpp`
**åŠŸèƒ½**: éšœç¢ç‰©å·¡èˆªä¸»èŠ‚ç‚¹

#### æ–‡ä»¶: `autoware_obstacle_cruise_planner/src/pid_based_planner.cpp`
**åŠŸèƒ½**: PID å·¡èˆªè§„åˆ’å™¨

---

### 5. Path Smoother - è·¯å¾„å¹³æ»‘

#### æ–‡ä»¶: `autoware_path_smoother/src/elastic_band_smoother.cpp`
**åŠŸèƒ½**: å¼¹æ€§å¸¦å¹³æ»‘å™¨ï¼Œä¼šä¿®æ”¹é€Ÿåº¦

---

## ğŸ› ï¸ æ·»åŠ æ—¥å¿—çš„æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨ RCLCPP_INFO_THROTTLE (æ¨è)

**ä¼˜ç‚¹**: é™åˆ¶æ—¥å¿—é¢‘ç‡ï¼Œé¿å…åˆ·å±

```cpp
// æ¯ç§’æœ€å¤šè¾“å‡ºä¸€æ¬¡
RCLCPP_INFO_THROTTLE(
  get_logger(), 
  *get_clock(), 
  1000,  // æ¯«ç§’
  "[VEL_DEBUG] æ¨¡å—å: é€Ÿåº¦å€¼ = %.2f m/s, ä½ç½®: å‡½æ•°å/è¡Œå·",
  velocity_value
);
```

### æ–¹æ³•2: ä½¿ç”¨ RCLCPP_DEBUG

**ä¼˜ç‚¹**: å¯é€šè¿‡æ—¥å¿—çº§åˆ«æ§åˆ¶å¼€å…³

```cpp
RCLCPP_DEBUG(
  get_logger(),
  "[VEL_DEBUG] è¯¦ç»†ä¿¡æ¯: velocity = %.3f",
  velocity_value
);
```

### æ–¹æ³•3: æ·»åŠ è¯Šæ–­ä¿¡æ¯

**ä¼˜ç‚¹**: å¯é€šè¿‡ `/diagnostics` è¯é¢˜å®æ—¶æŸ¥çœ‹

```cpp
diagnostic_msgs::msg::DiagnosticStatus status;
status.name = "velocity_debug";
status.level = diagnostic_msgs::msg::DiagnosticStatus::OK;
status.message = "Velocity: " + std::to_string(velocity);
```

---

## ğŸ“ æ¨èçš„æ—¥å¿—æ ¼å¼

### ç»Ÿä¸€æ ¼å¼
```
[VEL_DEBUG][æ¨¡å—å][é˜¶æ®µ] æè¿°: é€Ÿåº¦å€¼, é™„åŠ ä¿¡æ¯
```

### ç¤ºä¾‹

```cpp
// BPP è¾“å‡º
RCLCPP_INFO_THROTTLE(
  get_logger(), *get_clock(), 1000,
  "[VEL_DEBUG][BPP][OUTPUT] Final path velocity: %.2f m/s, points: %zu",
  output_path.points.front().point.longitudinal_velocity_mps,
  output_path.points.size()
);

// Goal Planner
RCLCPP_INFO(
  get_logger(),
  "[VEL_DEBUG][GoalPlanner][DECIDE] Current vel: %.2f, min vel: %.2f, decided vel: %.2f",
  current_vel,
  min_vel,
  decided_vel
);

// Avoidance
RCLCPP_INFO_THROTTLE(
  get_logger(), *get_clock(), 1000,
  "[VEL_DEBUG][Avoidance][INSERT] Original: %.2f -> Modified: %.2f at idx %zu",
  v_original,
  v_target,
  i
);
```

---

## ğŸ” å…³é”®å‡½æ•°æ·»åŠ ä½ç½®

### 1. BPP ä¸»èŠ‚ç‚¹è¾“å‡º

**æ–‡ä»¶**: `behavior_path_planner_node.cpp`

**å‡½æ•°**: `run()` æˆ– `publishPath()`

**æ·»åŠ ä½ç½®**: å‘å¸ƒè·¯å¾„å‰

```cpp
// åœ¨å‘å¸ƒå‰æ·»åŠ 
if (!output.path.points.empty()) {
  RCLCPP_INFO_THROTTLE(
    get_logger(), *get_clock(), 1000,
    "[VEL_DEBUG][BPP][PUBLISH] Output path first point vel: %.3f m/s, last point vel: %.3f m/s",
    output.path.points.front().point.longitudinal_velocity_mps,
    output.path.points.back().point.longitudinal_velocity_mps
  );
}
```

---

### 2. Goal Planner é€Ÿåº¦å†³ç­–

**æ–‡ä»¶**: `goal_planner_module.cpp`

**å‡½æ•°**: `decideVelocity()`

```cpp
void GoalPlannerModule::decideVelocity(PullOverPath & pull_over_path)
{
  const double current_vel = planner_data_->self_odometry->twist.twist.linear.x;
  
  auto & first_path = pull_over_path.partial_paths().front();
  const auto vel = static_cast<float>(
    std::max(current_vel, parameters_.pull_over_minimum_velocity)
  );
  
  // æ·»åŠ æ—¥å¿—
  RCLCPP_INFO(
    get_logger(),
    "[VEL_DEBUG][GoalPlanner][DECIDE] current_vel=%.3f, min_vel=%.3f, decided_vel=%.3f",
    current_vel,
    parameters_.pull_over_minimum_velocity,
    vel
  );
  
  for (auto & p : first_path.points) {
    const auto old_vel = p.point.longitudinal_velocity_mps;
    p.point.longitudinal_velocity_mps = std::min(p.point.longitudinal_velocity_mps, vel);
    
    // å¦‚æœé€Ÿåº¦è¢«ä¿®æ”¹ï¼Œæ‰“å°æ—¥å¿—
    if (std::abs(old_vel - p.point.longitudinal_velocity_mps) > 0.01) {
      RCLCPP_DEBUG(
        get_logger(),
        "[VEL_DEBUG][GoalPlanner][MODIFY] Point velocity: %.3f -> %.3f",
        old_vel,
        p.point.longitudinal_velocity_mps
      );
    }
  }
}
```

---

### 3. é¿éšœé€Ÿåº¦æ’å…¥

**æ–‡ä»¶**: `static_obstacle_avoidance_module.cpp`

**å‡½æ•°**: `insertAvoidanceVelocity()`

```cpp
void StaticObstacleAvoidanceModule::insertAvoidanceVelocity(ShiftedPath & shifted_path) const
{
  // ... ç°æœ‰ä»£ç  ...
  
  const auto [distance_to_accel_end_point, v_max] =
    helper_->getDistanceToAccelEndPoint(shifted_path.path);
    
  // æ·»åŠ æ—¥å¿—
  RCLCPP_INFO_THROTTLE(
    get_logger(), *get_clock(), 1000,
    "[VEL_DEBUG][Avoidance][INSERT] v_max=%.3f, distance_to_accel=%.3f",
    v_max,
    distance_to_accel_end_point
  );
  
  if (distance_to_accel_end_point < 1e-3) {
    RCLCPP_WARN_THROTTLE(
      get_logger(), *get_clock(), 2000,
      "[VEL_DEBUG][Avoidance][SKIP] Distance too small, skipping velocity insertion"
    );
    return;
  }
  
  // ... åœ¨å¾ªç¯ä¸­ ...
  for (size_t i = start_idx; i < shifted_path.path.points.size(); ++i) {
    const double v_original = shifted_path.path.points.at(i).point.longitudinal_velocity_mps;
    const double v_target = std::max(getEgoSpeed(), std::sqrt(v_target_square));
    shifted_path.path.points.at(i).point.longitudinal_velocity_mps = std::min(v_original, v_target);
    
    // æ¯10ä¸ªç‚¹æ‰“å°ä¸€æ¬¡
    if (i % 10 == 0) {
      RCLCPP_DEBUG(
        get_logger(),
        "[VEL_DEBUG][Avoidance][POINT_%zu] %.3f -> %.3f (ego_speed=%.3f)",
        i, v_original, shifted_path.path.points.at(i).point.longitudinal_velocity_mps, getEgoSpeed()
      );
    }
  }
}
```

---

### 4. Obstacle Cruise Planner

**æ–‡ä»¶**: `autoware_obstacle_cruise_planner/src/node.cpp`

**å‡½æ•°**: `onTrajectory()` æˆ–é€Ÿåº¦è®¡ç®—å‡½æ•°

```cpp
// åœ¨è®¡ç®—é€Ÿåº¦åæ·»åŠ 
RCLCPP_INFO_THROTTLE(
  get_logger(), *get_clock(), 1000,
  "[VEL_DEBUG][ObstacleCruise][PLAN] Input vel: %.3f, Output vel: %.3f, obstacle dist: %.3f",
  input_trajectory.points.front().longitudinal_velocity_mps,
  output_trajectory.points.front().longitudinal_velocity_mps,
  obstacle_distance
);
```

---

### 5. Path Smoother

**æ–‡ä»¶**: `autoware_path_smoother/src/elastic_band_smoother.cpp`

```cpp
// å¹³æ»‘å‰åå¯¹æ¯”
RCLCPP_INFO_THROTTLE(
  get_logger(), *get_clock(), 1000,
  "[VEL_DEBUG][PathSmoother][SMOOTH] Before: avg_vel=%.3f, After: avg_vel=%.3f",
  avg_vel_before,
  avg_vel_after
);
```

---

## ğŸš€ å¿«é€Ÿæ·»åŠ è„šæœ¬

### è‡ªåŠ¨æ·»åŠ è°ƒè¯•æ—¥å¿—çš„è¾…åŠ©è„šæœ¬

```bash
#!/bin/bash
# æ–‡ä»¶å: add_velocity_debug_logs.sh

# å¤‡ä»½æ–‡ä»¶
backup_file() {
  if [ ! -f "$1.bak" ]; then
    cp "$1" "$1.bak"
    echo "å·²å¤‡ä»½: $1 -> $1.bak"
  fi
}

# åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶æ ‡è®° longitudinal_velocity_mps çš„ä½ç½®
find_velocity_usage() {
  local file=$1
  echo "=== $file ==="
  grep -n "longitudinal_velocity_mps" "$file" | head -20
  echo ""
}

# ä¸»ç›®å½•
PLANNING_DIR="src/universe/autoware_universe/planning"

# å…³é”®æ–‡ä»¶åˆ—è¡¨
KEY_FILES=(
  "$PLANNING_DIR/behavior_path_planner/autoware_behavior_path_planner/src/behavior_path_planner_node.cpp"
  "$PLANNING_DIR/behavior_path_planner/autoware_behavior_path_goal_planner_module/src/goal_planner_module.cpp"
  "$PLANNING_DIR/behavior_path_planner/autoware_behavior_path_static_obstacle_avoidance_module/src/scene.cpp"
  "$PLANNING_DIR/autoware_obstacle_cruise_planner/src/node.cpp"
  "$PLANNING_DIR/autoware_obstacle_cruise_planner/src/pid_based_planner/pid_based_planner.cpp"
)

echo "æ­£åœ¨æ‰«æå…³é”®æ–‡ä»¶ä¸­çš„é€Ÿåº¦ä½¿ç”¨æƒ…å†µ..."
echo "================================================"
echo ""

for file in "${KEY_FILES[@]}"; do
  if [ -f "$file" ]; then
    find_velocity_usage "$file"
  else
    echo "æ–‡ä»¶ä¸å­˜åœ¨: $file"
  fi
done

echo "================================================"
echo "æ‰«æå®Œæˆï¼"
echo ""
echo "å»ºè®®æ‰‹åŠ¨åœ¨ä»¥ä¸Šä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—"
echo "æ ¼å¼: RCLCPP_INFO_THROTTLE(get_logger(), *get_clock(), 1000, \"[VEL_DEBUG]...\")"
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
chmod +x add_velocity_debug_logs.sh
./add_velocity_debug_logs.sh > velocity_usage_report.txt
```

---

## ğŸ“Š æ—¥å¿—åˆ†æå·¥å…·

### å®æ—¶è¿‡æ»¤é€Ÿåº¦æ—¥å¿—

```bash
#!/bin/bash
# æ–‡ä»¶å: monitor_velocity_logs.sh

echo "å®æ—¶ç›‘æ§ Planning æ¨¡å—é€Ÿåº¦æ—¥å¿—..."
echo "æŒ‰ Ctrl+C é€€å‡º"
echo "========================================"

# æ–¹æ³•1: ä» ROS æ—¥å¿—è¿‡æ»¤
ros2 topic echo /rosout | grep --line-buffered "\[VEL_DEBUG\]"

# æ–¹æ³•2: ä»ç³»ç»Ÿæ—¥å¿—è¿‡æ»¤ï¼ˆå¦‚æœä½¿ç”¨æ–‡ä»¶æ—¥å¿—ï¼‰
# tail -f ~/.ros/log/latest/autoware-*.log | grep --line-buffered "\[VEL_DEBUG\]"
```

### æå–é€Ÿåº¦å˜åŒ–å†å²

```bash
#!/bin/bash
# æ–‡ä»¶å: extract_velocity_history.sh

LOG_FILE="${1:-~/.ros/log/latest/*.log}"

echo "ä»æ—¥å¿—ä¸­æå–é€Ÿåº¦å˜åŒ–å†å²..."

grep "\[VEL_DEBUG\]" $LOG_FILE | \
  awk '{
    # æå–æ—¶é—´æˆ³å’Œé€Ÿåº¦å€¼
    if (match($0, /vel[^0-9]*([0-9.]+)/, arr)) {
      print $1, $2, arr[1]
    }
  }' | \
  sort -k2 > velocity_history.txt

echo "å·²ä¿å­˜åˆ° velocity_history.txt"
```

---

## ğŸ¨ RViz å¯è§†åŒ–é…ç½®

### æ·»åŠ é€Ÿåº¦æ˜¾ç¤º

1. åœ¨ RViz ä¸­æ·»åŠ  `Path` æˆ– `Trajectory` æ˜¾ç¤º
2. å¯ç”¨é€Ÿåº¦é¢œè‰²æ˜ å°„
3. æ ¹æ® `longitudinal_velocity_mps` ç€è‰²

**é…ç½®ç¤ºä¾‹**:
```yaml
- Class: rviz_default_plugins/Path
  Name: BPP Output Path
  Topic: /planning/scenario_planning/lane_driving/behavior_planning/path
  Color Scheme: Color by velocity
  Min Velocity: 0.0
  Max Velocity: 2.0
```

---

## ğŸ”§ ç¼–è¯‘å’Œæµ‹è¯•

### ä¿®æ”¹åé‡æ–°ç¼–è¯‘

```bash
# ä»…ç¼–è¯‘ planning ç›¸å…³åŒ…
colcon build --packages-select \
  autoware_behavior_path_planner \
  autoware_behavior_path_goal_planner_module \
  autoware_behavior_path_static_obstacle_avoidance_module \
  autoware_obstacle_cruise_planner \
  --cmake-args -DCMAKE_BUILD_TYPE=Debug

# é‡æ–° source
source install/setup.bash
```

### æµ‹è¯•æ—¥å¿—è¾“å‡º

```bash
# å¯åŠ¨ Autoware
ros2 launch autoware_launch e2e_simulator.launch.xml ...

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§æ—¥å¿—
ros2 topic echo /rosout | grep "\[VEL_DEBUG\]"
```

### è°ƒæ•´æ—¥å¿—çº§åˆ«

```bash
# è®¾ç½®ä¸º DEBUG çº§åˆ«ä»¥æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
ros2 run rqt_logger_level rqt_logger_level

# æˆ–å‘½ä»¤è¡Œè®¾ç½®
ros2 service call /behavior_path_planner/set_log_level \
  rcl_interfaces/srv/SetLoggerLevel \
  "{logger_name: '', level: 10}"
```

---

## ğŸ“ˆ é¢„æœŸæ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[INFO] [1234567890.123] [behavior_path_planner]: [VEL_DEBUG][BPP][PUBLISH] Output path first point vel: 1.234 m/s, last point vel: 0.000 m/s

[INFO] [1234567890.456] [goal_planner]: [VEL_DEBUG][GoalPlanner][DECIDE] current_vel=1.200, min_vel=0.300, decided_vel=1.200

[INFO] [1234567890.789] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][INSERT] v_max=1.500, distance_to_accel=10.500

[DEBUG] [1234567891.012] [static_obstacle_avoidance]: [VEL_DEBUG][Avoidance][POINT_0] 1.500 -> 1.234 (ego_speed=1.200)

[INFO] [1234567891.345] [obstacle_cruise_planner]: [VEL_DEBUG][ObstacleCruise][PLAN] Input vel: 1.234, Output vel: 0.800, obstacle dist: 5.600
```

---

## âœ… æ£€æŸ¥æ¸…å•

æ·»åŠ æ—¥å¿—åéªŒè¯ï¼š

- [ ] æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼Œéƒ½åŒ…å« `[VEL_DEBUG]` æ ‡è®°
- [ ] ä½¿ç”¨ `THROTTLE` é¿å…æ—¥å¿—åˆ·å±
- [ ] è®°å½•å…³é”®é€Ÿåº¦å˜åŒ–ç‚¹ï¼ˆä¿®æ”¹å‰åï¼‰
- [ ] åŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ¨¡å—åã€é˜¶æ®µï¼‰
- [ ] ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š
- [ ] è¿è¡Œæµ‹è¯•ï¼Œæ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] å¯é€šè¿‡ `grep` è½»æ¾è¿‡æ»¤

---

## ğŸ¯ æ€»ç»“

é€šè¿‡åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¯ä»¥å®Œæ•´è¿½è¸ªé€Ÿåº¦åœ¨ Planning æ¨¡å—ä¸­çš„è®¡ç®—å’Œä¼ é€’è¿‡ç¨‹ï¼Œä¾¿äºï¼š

1. âœ… å®šä½é€Ÿåº¦å¼‚å¸¸çš„æºå¤´
2. âœ… ç†è§£å„æ¨¡å—å¯¹é€Ÿåº¦çš„å½±å“
3. âœ… éªŒè¯å‚æ•°è°ƒæ•´çš„æ•ˆæœ
4. âœ… è¯Šæ–­é€Ÿåº¦ä¸ºé›¶çš„é—®é¢˜

**å»ºè®®ä¼˜å…ˆæ·»åŠ æ—¥å¿—çš„æ¨¡å—**:
1. BPP ä¸»èŠ‚ç‚¹è¾“å‡º
2. Goal Planner é€Ÿåº¦å†³ç­–
3. Obstacle Cruise Planner
4. Static Obstacle Avoidance

ç¥è°ƒè¯•é¡ºåˆ©ï¼ğŸš€

