# 如何实时查看Autoware的Lanelet地图速度限制 - 快速指南

## 🚀 快速开始

### 方法1：使用监控脚本（推荐）

**最简单的方式 - 一键查看所有速度限制信息：**

```bash
./check_speed_limit.sh
```

**输出示例：**
```
======================================
  Autoware 速度限制实时监控
======================================

[1] 当前最大速度限制
  最大速度限制: 15.0 m/s (54.0 km/h)
  来源: velocity_smoother

[2] 当前车速
  当前速度: 8.5 m/s (30.6 km/h)
  ✓ 速度正常 (56% 的限速)

[3] 当前轨迹速度分布
   45 个点: 0.00 m/s (0.0 km/h)
  120 个点: 8.33 m/s (30.0 km/h)
   35 个点: 13.89 m/s (50.0 km/h)

[4] 停止点检查
  ✓ 检测到 45 个停止点

[5] Behavior Planning路径速度（来自Lanelet地图）
  点速度: 8.33 m/s (30.0 km/h)
  点速度: 8.33 m/s (30.0 km/h)
  点速度: 8.33 m/s (30.0 km/h)

[6] 外部速度限制（如有）
  ✓ 无外部速度限制
```

### 方法2：使用ROS命令查看当前速度限制

```bash
# 查看当前应用的速度限制
ros2 topic echo /planning/scenario_planning/current_max_velocity

# 只看速度值
ros2 topic echo /planning/scenario_planning/current_max_velocity --once | grep max_velocity
```

### 方法3：在RViz中可视化查看

1. 启动Autoware后，RViz会自动显示
2. 在RViz窗口**左上角**可以看到仪表盘
3. **红色圆圈标志**显示的就是当前速度限制（单位：km/h）
4. 当车速接近限速时，圆圈会变成橙色/红色警告

## 📊 关键ROS话题

| 话题 | 功能 | 命令 |
|-----|------|------|
| `/planning/scenario_planning/current_max_velocity` | **当前速度限制** | `ros2 topic echo /planning/scenario_planning/current_max_velocity` |
| `/planning/scenario_planning/trajectory` | 轨迹点速度 | `ros2 topic echo /planning/scenario_planning/trajectory` |
| `/planning/scenario_planning/lane_driving/behavior_planning/path` | **地图原始速度** | `ros2 topic echo /planning/scenario_planning/lane_driving/behavior_planning/path` |
| `/vehicle/status/velocity_status` | 实际车速 | `ros2 topic echo /vehicle/status/velocity_status` |

## 🔍 常用查询命令

### 查看地图中定义的速度限制

```bash
# 查看behavior planning输出的路径（包含从lanelet地图读取的速度）
ros2 topic echo /planning/scenario_planning/lane_driving/behavior_planning/path --once | \
  grep "longitudinal_velocity_mps" | head -n 10
```

### 统计轨迹中的速度分布

```bash
ros2 topic echo /planning/scenario_planning/trajectory --once | \
  grep "longitudinal_velocity_mps" | \
  awk '{print $2}' | sort -n | uniq -c
```

### 持续监控速度限制变化

```bash
watch -n 0.5 "ros2 topic echo /planning/scenario_planning/current_max_velocity --once | grep 'max_velocity'"
```

### 检查速度限制来源

```bash
# 按优先级检查各个来源
echo "1. 外部速度限制："
ros2 topic echo /planning/scenario_planning/max_velocity --once | grep max_velocity

echo "2. 当前应用的速度限制："
ros2 topic echo /planning/scenario_planning/current_max_velocity --once | grep max_velocity

echo "3. 车辆命令网关限制："
ros2 param get /control/vehicle_cmd_gate nominal.vel_lim

echo "4. Planning模块最大速度："
ros2 param get /planning/scenario_planning/lane_driving/motion_planning/path_optimizer max_vel 2>/dev/null || echo "参数不存在"
```

## 💡 速度值转换

Autoware内部使用 **m/s**，地图中定义使用 **km/h**：

| m/s | km/h | 说明 |
|-----|------|------|
| 4.17 | 15 | 低速区域 |
| 8.33 | 30 | 城市道路 |
| 13.89 | 50 | 主干道 |
| 22.22 | 80 | 快速路 |

**快速转换公式：**
- m/s → km/h: 乘以 3.6
- km/h → m/s: 除以 3.6

## 🎯 实用技巧

### 1. 快速检查当前限速和车速

```bash
echo "限速: $(ros2 topic echo /planning/scenario_planning/current_max_velocity --once 2>/dev/null | grep max_velocity | awk '{print $2 * 3.6}') km/h"
echo "车速: $(ros2 topic echo /vehicle/status/velocity_status --once 2>/dev/null | grep longitudinal_velocity | awk '{print $2 * 3.6}') km/h"
```

### 2. 检查是否有停止点

```bash
STOP_POINTS=$(ros2 topic echo /planning/scenario_planning/trajectory --once 2>/dev/null | grep "longitudinal_velocity_mps: 0.0" | wc -l)
echo "轨迹中有 $STOP_POINTS 个停止点"
```

### 3. 查看地图文件中的速度限制定义

```bash
# 找到你的地图文件路径后执行
grep "speed_limit" /path/to/your_map.osm | grep -o 'v="[0-9.]*"' | sort | uniq -c
```

## 🐛 故障排查

### 问题1：话题没有数据
```bash
# 检查Autoware是否正常运行
ros2 topic list | grep planning

# 检查话题发布频率
ros2 topic hz /planning/scenario_planning/current_max_velocity
```

### 问题2：速度限制为0
可能原因：
- Lanelet地图中未设置speed_limit标签
- traffic_rules未正确加载
- 检查地图文件中是否有speed_limit定义

### 问题3：车辆不遵守地图限速
检查优先级更高的限制：
1. 外部速度限制（最高优先级）
2. vehicle_cmd_gate的vel_lim参数
3. planning模块的max_vel参数

## 📖 详细文档

完整的技术细节和代码位置，请参考：
- `lanelet地图速度限制参数说明.md` - 完整技术文档

## 🛠️ 工具位置

- 监控脚本：`./check_speed_limit.sh`
- RViz配置：`src/launcher/autoware_launch/autoware_launch/rviz/autoware.rviz`
- 速度显示插件：`src/universe/autoware_universe/visualization/autoware_overlay_rviz_plugin/`

---

**提示：** 在Autoware运行时执行上述命令才能看到数据。如果系统未运行，话题不会有数据输出。

