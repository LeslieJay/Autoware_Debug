# Behavior Path Planner 模块协作快速参考

## 📋 场景：遇到路边停车车辆

```
初始状态:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Lane 1  ═══════════════════════════════════
 Lane 2  ══════════╗🚗停车╔════════════════  ← Ego在此
 Lane 3  ═══════════════════════════════════
         0m      50m     100m
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔄 处理流程一览

### 步骤1️⃣: 请求检查（Request Check）

| 模块 | 检测结果 | 是否请求 |
|-----|---------|---------|
| Static Obstacle Avoidance | 50m处有障碍物 | ✅ YES |
| Lane Change Left | 左侧车道可用且安全 | ✅ YES |
| Lane Change Right | 右侧无车道 | ❌ NO |
| Side Shift | 无需主动请求 | ❌ NO |

---

### 步骤2️⃣: 候选生成（Candidate Generation）- 并行

#### 方案A：Static Obstacle Avoidance

```
输入:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
PathWithLaneId {
  points: [
    {s: 0m,  y: 0m, lane: [200], v: 8.33 m/s},
    {s: 10m, y: 0m, lane: [200], v: 8.33 m/s},
    {s: 50m, y: 0m, lane: [200], v: 8.33 m/s},  ← 障碍物位置
    {s: 100m, y: 0m, lane: [200], v: 8.33 m/s}
  ]
}

处理:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 检测障碍物: 50m处，宽1.8m
2. 计算偏移量: 1.9m（障碍物一半+安全边距）
3. 生成避障轨迹:
   - 30-50m: 横向偏移 0 → 1.9m
   - 50-70m: 横向偏移 1.9m → 0
4. 调整速度:
   - 40-60m: 减速到 6.0 m/s
5. 设置转向灯: LEFT (30m开始)

输出:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CandidatePath {
  points: [
    {s: 30m, y: 0.0m,  v: 8.33 m/s},  ← 开始偏移
    {s: 40m, y: 0.95m, v: 7.2 m/s},   ← 减速
    {s: 50m, y: 1.9m,  v: 6.0 m/s},   ← 最大偏移，通过障碍物
    {s: 60m, y: 0.95m, v: 7.2 m/s},   ← 回归
    {s: 70m, y: 0.0m,  v: 8.33 m/s}   ← 恢复正常
  ],
  turn_signal: LEFT,
  status: WAITING_APPROVAL
}

可视化:
  Lane 2: ═══════╗🚗╔═══════
          ↗ ↗ ↗→→→↘ ↘ ↘     ← 避障轨迹
```

#### 方案B：Lane Change Left

```
输入:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
PathWithLaneId {
  points: [
    {s: 0m,  y: 0m, lane: [200], v: 8.33 m/s},
    {s: 50m, y: 0m, lane: [200], v: 8.33 m/s},
    {s: 100m, y: 0m, lane: [200], v: 8.33 m/s}
  ]
}

处理:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 检查左侧车道: Lane 1可用
2. 安全性检查: 左侧无障碍物，可换道
3. 计算换道参数:
   - 换道距离: 30m (20-50m)
   - 横向位移: 3.5m (车道宽度)
4. 生成换道轨迹:
   - 20-50m: y从0→3.5m
   - lane_ids: 200→[200,100]→100
5. 速度调整:
   - 换道时根据曲率轻微减速到 8.0 m/s
6. 设置转向灯: LEFT (15m开始)

输出:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CandidatePath {
  points: [
    {s: 20m, y: 0.0m,  lane: [200],     v: 8.33 m/s},  ← 开始换道
    {s: 30m, y: 1.17m, lane: [200,100], v: 8.33 m/s},
    {s: 40m, y: 2.33m, lane: [200,100], v: 8.0 m/s},
    {s: 50m, y: 3.5m,  lane: [100],     v: 8.33 m/s},  ← 完成换道
    {s: 60m, y: 3.5m,  lane: [100],     v: 8.33 m/s}   ← 在左车道
  ],
  turn_signal: LEFT,
  status: WAITING_APPROVAL
}

可视化:
  Lane 1: ↗ ↗ ↗ ↗ → → → → →  ← 换道到Lane 1
  Lane 2: ═══════╗🚗╔═══════
```

---

### 步骤3️⃣: 决策评估（Evaluation & Approval）

```
┌─────────────────────────────────────────────────────────┐
│ 评估指标                                                 │
├─────────────────────────────┬───────────┬───────────────┤
│ 指标                         │ 方案A     │ 方案B         │
│                             │ (避障)    │ (换道)        │
├─────────────────────────────┼───────────┼───────────────┤
│ Safety（安全性）             │ 0.8       │ 0.9 ✓        │
│ - 与障碍物距离               │ 1.9m      │ 整个车道(3.5m)│
│                             │           │               │
│ Comfort（舒适性）            │ 0.7       │ 0.9 ✓        │
│ - 横向加速度                 │ 较大      │ 平滑          │
│ - 速度变化                   │ 减速明显  │ 保持平稳      │
│                             │           │               │
│ Efficiency（效率）           │ 0.6       │ 0.9 ✓        │
│ - 速度损失                   │ 6.0 m/s   │ 8.0-8.33 m/s │
│ - 行驶时间                   │ 较长      │ 较短          │
│                             │           │               │
│ Total Score（总分）          │ 0.70      │ 0.90 🏆      │
└─────────────────────────────┴───────────┴───────────────┘

决策结果: 批准方案B (Lane Change Left)
```

---

### 步骤4️⃣: 批准执行（Approved Execution）- 串行

```
Approved Stack 状态:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[Lane Change Left] → RUNNING (Approved)

输入:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
BehaviorModuleOutput (来自Slot 1)
  path: Lane 2中心线路径
  velocity: 8.33 m/s

执行:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
output = lane_change_left_module->run(input);

输出:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
BehaviorModuleOutput {
  path: 换道路径（Lane 2 → Lane 1）
  velocity: 8.0-8.33 m/s
  turn_signal: LEFT (15-50m)
  drivable_area: [Lane 1, Lane 2]  ← 换道时两车道都可用
}

最终结果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Lane 1: ↗ ↗ ↗ ↗ → → → → → (Ego在此)
  Lane 2: ═══════╗🚗╔═══════ (障碍物已避开)
```

---

## 📊 数据流对比图

### Candidate阶段（并行）vs Approved阶段（串行）

```
┌───────────────────────────────────────────────────────────────┐
│              Candidate阶段（并行生成方案）                     │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Input (相同): Reference Path                                 │
│         │                                                      │
│         ├──────────────────┬──────────────────┐               │
│         ↓                  ↓                  ↓               │
│   Module A           Module B           Module C             │
│   (Static Avoid)    (Lane Change)      (不请求)              │
│         ║                  ║                                  │
│         ║ 独立处理          ║ 独立处理                         │
│         ║                  ║                                  │
│         ↓                  ↓                                  │
│   Candidate A        Candidate B                             │
│   (横向偏移)         (换道路径) ✓ 被批准                      │
│         │                  │                                  │
│         └─────> 可视化显示，等待决策                          │
│                                                                │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│              Approved阶段（串行执行路径）                       │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Input: Reference Path                                        │
│         │                                                      │
│         ↓                                                      │
│   Module B (Lane Change) - APPROVED                           │
│         ║                                                      │
│         ║ 修改路径：换道                                       │
│         ║                                                      │
│         ↓                                                      │
│   Output: 换道路径                                            │
│         │                                                      │
│         ↓ (如果还有其他Approved模块)                          │
│   Module X - APPROVED                                         │
│         ║                                                      │
│         ║ 基于换道路径继续修改                                 │
│         ║                                                      │
│         ↓                                                      │
│   Final Output                                                │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

---

## 🔍 输入输出快速对照

### Static Obstacle Avoidance Module

```
┌──────────────┬─────────────────────────────────────────────┐
│ 阶段          │ 数据                                        │
├──────────────┼─────────────────────────────────────────────┤
│ 输入          │ Path: Lane2中心线                           │
│              │ Points: y=0m, velocity=8.33m/s              │
│              │ Obstacle: (50m, 0m, PARKED)                 │
├──────────────┼─────────────────────────────────────────────┤
│ 处理          │ 生成避障轨迹                                │
│              │ - 横向偏移: 0 → 1.9m → 0                   │
│              │ - 速度调整: 8.33 → 6.0 → 8.33 m/s         │
│              │ - 转向灯: LEFT                              │
├──────────────┼─────────────────────────────────────────────┤
│ 输出          │ Path: Lane2偏移路径                         │
│ (Candidate)  │ Points: 30-70m横向偏移                      │
│              │ Status: WAITING_APPROVAL                    │
│              │ 结果: 未被批准（换道方案更优）               │
└──────────────┴─────────────────────────────────────────────┘
```

### Lane Change Left Module

```
┌──────────────┬─────────────────────────────────────────────┐
│ 阶段          │ 数据                                        │
├──────────────┼─────────────────────────────────────────────┤
│ 输入          │ Path: Lane2中心线                           │
│              │ Points: y=0m, lane=[200], v=8.33m/s         │
│              │ Left Lane: 可用且安全                       │
├──────────────┼─────────────────────────────────────────────┤
│ 处理          │ 生成换道轨迹                                │
│ (Candidate)  │ - 横向位移: 0 → 3.5m (车道宽度)           │
│              │ - 换道区间: 20-50m                          │
│              │ - Lane IDs: 200 → [200,100] → 100          │
│              │ - 速度: 保持8.0-8.33m/s                     │
│              │ - 转向灯: LEFT                              │
├──────────────┼─────────────────────────────────────────────┤
│ 输出          │ Path: 换道路径                              │
│ (Candidate)  │ Status: WAITING_APPROVAL                    │
│              │ 评分: 0.9 (最高) ✓                         │
├──────────────┼─────────────────────────────────────────────┤
│ 执行          │ 🎯 被批准，移到Approved Stack              │
│ (Approved)   │ 实际执行换道                                │
│              │ 激活转向灯                                  │
│              │ 更新可行驶区域                              │
├──────────────┼─────────────────────────────────────────────┤
│ 最终输出      │ Path: Lane1路径 (成功避开障碍物)           │
│              │ Turn Signal: LEFT (15-50m)                  │
│              │ Drivable Area: [Lane1, Lane2]              │
│              │ Status: RUNNING → SUCCESS (完成后)         │
└──────────────┴─────────────────────────────────────────────┘
```

---

## ⏱️ 时序对照

```
Planning Cycle (100ms @ 10Hz)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Cycle 1: 检测到障碍物
├─ Request Check: Static Avoid ✓, Lane Change ✓
├─ Candidate Run (并行):
│  ├─ Static Avoid → Candidate Path A
│  └─ Lane Change → Candidate Path B
├─ Evaluation: Lane Change获胜 (0.9 > 0.7)
└─ Approval: Lane Change → Approved Stack

Cycle 2: 开始执行换道
├─ Approved Run (串行):
│  └─ Lane Change → 生成换道路径
├─ Turn Signal: 激活LEFT
├─ Output: 换道路径 (20-50m)
└─ Ego: 开始横向移动

Cycle 3-5: 执行换道中...
├─ Ego Position: y = 0 → 1.17 → 2.33 → 3.5m
├─ Lane IDs: [200] → [200,100] → [100]
└─ Status: RUNNING

Cycle 6: 换道完成
├─ Ego Position: Lane 1 (y = 3.5m)
├─ Obstacle: 已避开 (在Lane 2)
├─ Lane Change Status: RUNNING → SUCCESS
└─ Module: 从Approved Stack移除
```

---

## 🎯 关键理解点

### 1. 并行 vs 串行

```
┌─────────────────────────────────────────────────────────┐
│ Candidate（并行）                                        │
├─────────────────────────────────────────────────────────┤
│ ✓ 所有模块接收相同输入                                   │
│ ✓ 同时生成多个方案                                      │
│ ✓ 互不干扰                                              │
│ ✓ 可以比较和选择最优                                    │
│ ✗ 不影响实际路径                                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Approved（串行）                                         │
├─────────────────────────────────────────────────────────┤
│ ✓ 模块按顺序执行                                        │
│ ✓ 每个模块处理上一个的输出                              │
│ ✓ 路径连续修改                                          │
│ ✓ 直接影响车辆行驶                                      │
│ ✗ 不能并行（会冲突）                                    │
└─────────────────────────────────────────────────────────┘
```

### 2. 输入输出关系

```
Candidate阶段:
  Input → ModuleA → OutputA (候选)
            ↓
  Input → ModuleB → OutputB (候选) ← 相同输入
            ↓
  Input → ModuleC → OutputC (候选)

Approved阶段:
  Input → ModuleA → OutputA
                      ↓
            ModuleB → OutputB ← 基于OutputA
                      ↓
            ModuleC → OutputC ← 基于OutputB
```

### 3. 状态转换

```
IDLE (空闲)
  ↓ isExecutionRequested() = true
WAITING_APPROVAL (Candidate)
  ↓ 批准决策
RUNNING (Approved)
  ↓ 任务完成
SUCCESS / FAILURE
  ↓
(模块移除)
```

---

## 🛠️ 调试技巧

```bash
# 1. 查看哪些模块在运行
ros2 topic echo /.../debug/scene_module_status | grep -A 3 "module_name"

# 2. 查看候选路径（可视化）
ros2 topic echo /.../path_candidate/static_obstacle_avoidance
ros2 topic echo /.../path_candidate/lane_change_left

# 3. 查看最终输出
ros2 topic echo /planning/behavior_planning/path_with_lane_id | head -50

# 4. 查看转向灯状态
ros2 topic echo /planning/turn_indicators_cmd

# 5. 一键诊断
./debug_bpp_velocity.sh
```

---

## 📚 完整文档

详细的代码级别说明请参考：
- [BPP模块协作详细实例.md](./BPP模块协作详细实例.md) - 完整示例（代码级）
- [behavior_path_planner场景模块工作原理详解.md](./behavior_path_planner场景模块工作原理详解.md) - 架构说明
- [BPP路径生成流程图.md](./BPP路径生成流程图.md) - 可视化流程

---

**总结：** Candidate模块并行探索多种方案，Approved模块串行执行最优方案。每个模块都是独立的"专家"，负责特定场景的路径规划，最终Manager协调选择最佳方案执行。

